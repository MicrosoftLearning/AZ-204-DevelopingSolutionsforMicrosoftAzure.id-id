---
lab:
  az204Title: 'Lab 07: Access resource secrets more securely across services'
  az020Title: 'Lab 07: Access resource secrets more securely across services'
  az204Module: 'Module 07: Implement secure cloud solutions'
  az020Module: 'Module 07: Implement secure cloud solutions'
ms.openlocfilehash: 9638ad805940d8343646cd2790f2b6a06d9952df
ms.sourcegitcommit: 9abfe3b5a1c9ccd2f0610348052d04169573f81a
ms.translationtype: HT
ms.contentlocale: id-ID
ms.lasthandoff: 06/01/2022
ms.locfileid: "145994989"
---
# <a name="lab-07-access-resource-secrets-more-securely-across-services"></a>Lab 07: Akses rahasia sumber daya dengan lebih aman di seluruh layanan

## <a name="microsoft-azure-user-interface"></a>Antarmuka pengguna Microsoft Azure

Mengingat sifat dinamis alat cloud Microsoft, Anda mungkin mengalami perubahan UI Azure yang terjadi setelah pengembangan konten pelatihan ini. Akibatnya, instruksi lab dan langkah-langkah lab mungkin tidak selaras dengan benar.

Microsoft memperbarui kursus pelatihan ini ketika komunitas menyampaikan perubahan yang diperlukan untuk menjadi perhatian kami. Namun, karena pembaruan cloud sering terjadi, Anda mungkin mengalami perubahan UI sebelum pembaruan isi pelatihan ini. **Jika hal ini terjadi, sesuaikan dengan perubahan, lalu kerjakan perubahan di lab sesuai kebutuhan.**

## <a name="instructions"></a>Instruksi

### <a name="before-you-start"></a>Sebelum Anda memulai

#### <a name="sign-in-to-the-lab-environment"></a>Masuk ke lingkungan lab

Masuk ke mesin virtual (VM) Windows 10 Anda menggunakan kredensial berikut:

- Nama pengguna: **Admin**
- Kata sandi: **Pa55w.rd**

> **Catatan**: Instruktur Anda akan memberikan instruksi untuk terhubung ke lingkungan lab virtual.

#### <a name="review-the-installed-applications"></a>Meninjau aplikasi yang diinstal

Temukan taskbar di desktop Windows 10 Anda. Taskbar berisi ikon untuk aplikasi yang akan Anda gunakan di lab ini, termasuk:

- Microsoft Edge
- File Explorer
- Windows Terminal
- Visual Studio Code

## <a name="architecture-diagram"></a>Diagram arsitektur

![Diagram arsitektur yang menggambarkan pengguna mengakses rahasia sumber daya dengan lebih aman di seluruh layanan.](./media/Lab07-Diagram.png)

### <a name="exercise-1-create-azure-resources"></a>Latihan 1: Membuat sumber daya Azure

#### <a name="task-1-open-the-azure-portal"></a>Tugas 1: Membuka portal Azure

1. Pada taskbar, pilih ikon **Microsoft Edge**.

1. Di jendela browser yang terbuka, jelajahi portal Azure (<https://portal.azure.com>), lalu masuk dengan akun yang akan Anda gunakan untuk lab ini.

    > **Catatan**: Jika ini pertama kalinya Anda masuk ke portal Microsoft Azure, Anda akan diberikan penawaran tur portal. Pilih **Memulai** untuk melewati tur dan mulai menggunakan portal.

#### <a name="task-2-create-a-storage-account"></a>Tugas 2: Membuat akun Penyimpanan

1. Di portal Microsoft Azure, gunakan kotak teks **Cari sumber daya, layanan, dan dokumen** untuk mencari **Akun Penyimpanan**, lalu dalam daftar hasil, pilih **Akun penyimpanan**.

1. Pada panel **Akun penyimpanan**, pilih **+ Buat**.

1. Pada panel **Buat akun penyimpanan**, pada tab **Dasar**, lakukan tindakan berikut, dan pilih **Tinjau + buat**:

   | Pengaturan | Tindakan |
   | --- | --- |
   | Daftar drop-down **Langganan**   | Pertahankan nilai default |
   | Bagian **Grup sumber daya**        | Pilih **Buat baru**, masukkan **ConfidentialStack**, lalu pilih **OK** |
   | Kotak teks **Nama akun penyimpanan** | Masukkan **securestor** _[yourname]_ |
   | Daftar drop-down **Wilayah**         | Pilih **(US) US Timur** |
   | Bagian **Performa**           | Pilih opsi **Standar** |
   | Daftar drop-down **Redundansi**     | pilih **Penyimpanan redundan secara lokal (LRS)** |

   Cuplikan layar berikut menampilkan pengaturan yang dikonfigurasi pada bilah **Buat akun penyimpanan**.

   ![Cuplikan layar yang menampilkan pengaturan yang dikonfigurasi pada panel Buat akun penyimpanan](./media/l07_create_a_storage_account.png)

1. Pada tab **Tinjau + buat**, tinjau opsi yang Anda pilih di langkah sebelumnya.

1. Pilih **Buat** untuk membuat akun penyimpanan menggunakan konfigurasi yang Anda tentukan.

    > **Catatan**: Tunggu hingga tugas pembuatan selesai sebelum Anda melanjutkan dengan lab ini.

1. Pada panel **Gambaran Umum Penyebaran**, pilih **Buka sumber daya**.

1. Pada panel **Akun penyimpanan**, di bagian **Keamanan + jaringan**, pilih tautan **Kunci akses**.

1. Di bagian **Kunci akses**, pilih **Tampilkan kunci**.

1. Pilih salah satu kunci dan catat nilainya di salah satu kotak **String koneksi**. Anda akan menggunakan nilai ini nanti di lab ini.

    > **Catatan**: Tidak masalah string koneksi mana yang Anda pilih. Kunci mana pun dapat dipertukarkan.

#### <a name="task-3-create-an-azure-key-vault"></a>Tugas 3: Membuat Azure Key Vault

1. Di portal Microsoft Azure, gunakan kotak teks **Cari sumber daya, layanan, dan dokumen** untuk mencari **Brankas kunci**, lalu di daftar hasil, pilih **Brankas kunci**.

1. Pada panel **Brankas kunci**, pilih **Buat**.

1.  Pada panel **Buat brankas kunci**, pada tab **Dasar**, lakukan tindakan berikut, lalu pilih **Tinjau + buat**:

    | Pengaturan                           | Tindakan                                    |
    | --------------------------------- | ----------------------------------------- |
    | Daftar drop-down **Langganan**   | Pertahankan nilai default.                 |
    | Daftar drop-down **Grup sumber daya** | Pilih **ConfidentialStack** dalam daftar. |
    | Kotak teks **Nama brankas kunci**       | Masukkan **securevault** _[yourname]_ .        |
    | Daftar drop-down **Wilayah**         | Pilih **US Timur**.                       |
    | Daftar drop-down **Tingkat harga**   | pilih **Standar**.                      |

    Cuplikan layar berikut menampilkan pengaturan yang dikonfigurasi pada bilah **Buat brankas kunci**.

    ![Cuplikan layar yang menampilkan pengaturan yang dikonfigurasi pada bilah Buat brankas kunci](./media/l07_create_key_vault.png)

1. Pada tab **Tinjau + buat**, tinjau opsi yang Anda pilih di langkah sebelumnya.

1. Pilih **Buat** untuk membuat brankas kunci menggunakan konfigurasi yang Anda tentukan.

    > **Catatan**: Tunggu hingga tugas pembuatan selesai sebelum Anda melanjutkan dengan lab ini.

#### <a name="task-4-create-a-function-app"></a>Tugas 4: Membuat aplikasi Fungsi

1. Di portal Microsoft Azure, gunakan kotak teks **Cari sumber daya, layanan, dan dokumen** untuk mencari **Aplikasi Fungsi**, lalu di daftar hasil, pilih **Aplikasi Fungsi**.

1. Pada panel **Aplikasi Fungsi**, pilih **Buat**.

1. Pada panel **Buat Aplikasi Fungsi**, pada tab **Dasar**, lakukan tindakan berikut, lalu pilih **Berikutnya: Hosting**:

    | Pengaturan                           | Tindakan                            |
    | --------------------------------- | --------------------------------- |
    | Daftar drop-down **Langganan**   | Pertahankan nilai default         |
    | Daftar drop-down **Grup sumber daya** | Pilih **ConfidentialStack**     |
    | Kotak teks **Nama Aplikasi Fungsi**    | Masukkan **securefunc** _[yourname]_ |
    | Bagian **Perenerbitan**               | Pilih **Kode** |
    | Daftar drop-down **Tumpukan runtime**  | Pilih **.NET** |
    | Daftar dropdown **Versi**        | Pilih **3.1** |
    | Daftar drop-down **Wilayah**         | Pilih wilayah **US Timur**. |
    | Tombol radio **sistem operasi** | **Pilih Linux** |
    | Daftar drop-down **Jenis paket**      | Pilih **Konsumsi (Tanpa Server)** |


1. Pada tab **Hosting**, lakukan tindakan berikut, lalu pilih **Tinjau + buat**:

    | Pengaturan | Tindakan |
    | --- | --- |
    | Daftar dropdown **Akun penyimpanan** | Pilih akun penyimpanan **securestor** _[yourname]_ |

1. Pada tab **Tinjau + buat**, tinjau opsi yang Anda pilih di langkah sebelumnya.

1. Pilih **Buat** untuk membuat aplikasi fungsi menggunakan konfigurasi yang Anda tentukan.

    > **Catatan**: Tunggu hingga tugas pembuatan selesai sebelum Anda melanjutkan dengan lab ini.

#### <a name="review"></a>Tinjau

Dalam latihan ini, Anda membuat semua sumber daya yang akan Anda gunakan di lab ini.

### <a name="exercise-2-configure-secrets-and-identities"></a>Latihan 2: Mengonfigurasikan rahasia dan identitas

#### <a name="task-1-configure-a-system-assigned-managed-service-identity"></a>Tugas 1: Mengonfigurasikan identitas layanan terkelola yang ditetapkan sistem

1. Di panel navigasi portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih aplikasi fungsi **securefunc** _[yourname]_ .

    > **Catatan**: Akan ada dua sumber daya yaitu sumber daya application insights dan aplikasi fungsi, dengan nama yang sama. Pastikan Anda memilih sumber daya aplikasi fungsi.

1. Pada panel **Aplikasi Fungsi**, pilih opsi **Identitas** dari bagian **Pengaturan**.

1. Pada panel **Identitas**, pada tab **Sistem ditugaskan**, atur **Status** menjadi **On**, lalu pilih **Save**.

1. Pilih **Ya** untuk mengonfirmasi pengaturan.

    > **Catatan**: Tunggu hingga identitas terkelola yang ditetapkan sistem dibuat sebelum Anda melanjutkan lab ini.

#### <a name="task-2-create-a-key-vault-secret"></a>Tugas 2: Membuat rahasia Kunci Vault

1. Di panel **navigasi** portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih brankas kunci **securevault** _[yourname]_ .

1. Pada panel **Brankas Kunci**, pilih tautan **Rahasia** di bagian **Pengaturan**.

1. Pada panel **Rahasia**, pilih **+ Hasilkan/Impor**.

1. Pada panel **Buat rahasia**, lakukan tindakan berikut, lalu pilih **Buat**:

    | Pengaturan | Tindakan |
    | --- |  --- |
    | Daftar dropdown **Opsi unggah** | Pilih **Manual** |
    | Kotak teks **Nama**       | Masukkan **storagecredentials** |
    | kotak teks **Nilai**       | Masukkan string koneksi akun penyimpanan yang Anda rekam sebelumnya di lab ini.               |
    | Kotak teks **Jenis konten** | Biarkan kosong. |
    | Kotak centang **Atur tanggal aktivasi** | Tidak dipilih. |
    | Kotak centang **Atur tanggal kedaluwarsa** | Tidak dipilih. |
    | Opsi **Diaktifkan** | Pilih **Ya**. |

    Cuplikan layar berikut menampilkan pengaturan yang dikonfigurasi pada bilah **Buat rahasia**.

    ![Cuplikan layar yang menampilkan pengaturan yang dikonfigurasi pada bilah Buat rahasia ](./media/l07_create_a_secret.png)

    > **Catatan**: Tunggu rahasianya agar dibuat sebelum Anda melanjutkan dengan lab ini.

1. Kembali ke panel **Rahasia**, lalu pilih item **storagecredentials** dalam daftar.

1. Pada panel **Versi**, pilih versi terbaru dari rahasia **storagecredentials**.

1. Pada panel **Secret Version**, lakukan tindakan berikut:

    1. Pilih **Tampilkan nilai rahasia** untuk menemukan nilai rahasia.

    1. Catat nilai kotak teks **Pengidentifikasi Rahasia** karena Anda akan menggunakannya nanti di lab.

    > **Catatan**: Anda merekam nilai kotak teks **Pengidentifikasi Rahasia**, bukan kotak teks **Nilai Rahasia**.

#### <a name="task-3-configure-a-key-vault-access-policy"></a>Tugas 3: Konfigurasikan kebijakan akses Brankas Kunci

1. Di panel navigasi portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih brankas kunci **securevault[yourname]** .

1. Pada panel **Brankas kunci**, pilih tautan **Kebijakan akses** di bagian **Pengaturan**.

1. Pada panel **Kebijakan akses**, pilih **Tambahkan Kebijakan Akses**.

1. Pada panel **Tambahkan kebijakan akses**, lakukan tindakan berikut, lalu pilih **Tambahkan**:

    | Pengaturan | Tindakan |
    | --- | --- |
    | Daftar dropdown **Konfigurasikan dari templat** | Biarkan kosong |
    | Daftar dropdown **Izin utama** | 0 dipilih |
    | Daftar dropdown **Izin rahasia** | Pilih izin **GET** |
    | Daftar dropdown **Izin sertifikat** | 0 dipilih |
    | Tautan **Pilih prinsipal** | Temukan lalu pilih prinsip layanan bernama **securefunc** _[yourname]_ . Identitas terkelola yang ditetapkan sistem yang Anda buat sebelumnya di lab ini akan memiliki nama yang sama dengan sumber daya Azure Function. |
    | Tautan **Aplikasi resmi** | Tidak ada yang dipilih |

    Cuplikan layar berikut menampilkan pengaturan yang dikonfigurasi di bilah **Tambahkan kebijakan akses**.

    ![Cuplikan layar yang menggambarkan pengaturan yang dikonfigurasi pada bilah kebijakan Tambahkan akses.](./media/l07_add_access_policy.png)

1. Pada panel **Kebijakan akses**, pilih **Simpan**.

    > **Catatan**: Tunggu hingga perubahan Anda pada kebijakan akses disimpan sebelum melanjutkan dengan lab ini.

#### <a name="task-4-create-a-key-vault-derived-application-setting"></a>Tugas 4: Buat pengaturan aplikasi yang diturunkan dari Brankas Kunci

1. Di panel navigasi portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih aplikasi fungsi **securefunc[yourname]** .

1. Pada panel **Aplikasi Fungsi**, pilih opsi **Konfigurasi** dari bagian **Pengaturan**.

1. Pada panel **Konfigurasi**, pada tab **Pengaturan aplikasi**, pilih **Pengaturan aplikasi baru**.

1. Di jendela pop-up **pengaturan aplikasi Tambah/Edit**, di kotak teks **Nama**, masukkan **StorageConnectionString**.

1. Di kotak teks **Value**, buat nilai menggunakan sintaksis berikut: ``@Microsoft.KeyVault(SecretUri=*Secret Identifier*)``

    > **Catatan**: Anda harus membangun referensi ke **_Pengidentifikasi Rahasia_** Anda menggunakan sintaksis di atas. Misalnya, jika pengenal rahasia Anda adalah `https://securevaultstudent.vault.azure.net/secrets/storagecredentials/17b41386df3e4191b92f089f5efb4cbf`, nilai Anda akan menjadi `@Microsoft.KeyVault(SecretUri=https://securevaultstudent.vault.azure.net/secrets/storagecredentials/17b41386df3e4191b92f089f5efb4cbf)`.

1. Biarkan kotak centang **pengaturan slot penyebaran** diatur ke nilai defaultnya (tidak dipilih), lalu pilih **OK** untuk menutup jendela pop-up dan kembali ke bagian **Konfigurasi**.

1. Pilih **Simpan** untuk menyimpan pengaturan Anda, lalu di kotak dialog pop-up konfirmasi **simpan Perubahan**, pilih **Lanjutkan**.

    > **Catatan**: Tunggu hingga pengaturan aplikasi Anda disimpan sebelum melanjutkan ke lab.

#### <a name="review"></a>Tinjau

Dalam latihan ini, Anda membuat identitas layanan terkelola yang ditetapkan sistem untuk aplikasi fungsi Anda, lalu memberikan identitas tersebut izin yang sesuai untuk mendapatkan nilai rahasia di brankas kunci Anda. Terakhir, Anda membuat rahasia yang Anda referensikan dalam pengaturan konfigurasi aplikasi fungsi Anda.

### <a name="exercise-3-build-an-azure-functions-app"></a>Latihan 3: Membangun aplikasi Azure Functions

#### <a name="task-1-initialize-a-function-project"></a>Tugas 1: Menginisialisasi proyek fungsi

1. Pada taskbar, pilih ikon **Terminal Windows**.

1. Jalankan perintah berikut untuk mengubah direktori saat ini ke direktori kosong **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

    > **Catatan**: Di Windows Explorer, hapus atribut Baca-saja dari file F:\Allfiles\Labs\07\Starter\func\.gitignore.

1. Jalankan perintah berikut untuk menggunakan **Azure Functions Core Tools** guna membuat proyek Functions lokal baru di direktori saat ini menggunakan runtime **dotnet**:

    ```powershell
    func init --worker-runtime dotnet --force
    ```

    > **Catatan**: Anda dapat meninjau dokumentasi untuk [create a new project][azure-functions-core-tools-new-project] menggunakan **Azure Functions Core Tools**.

1. Jalankan perintah berikut untuk **membangun** proyek .NET Core 3.1:

    ```powershell
    dotnet build
    ```

#### <a name="task-2-create-an-http-triggered-function"></a>Tugas 2: Membuat fungsi yang dipicu HTTP

1. Jalankan perintah berikut untuk menggunakan **Azure Functions Core Tools** untuk membuat fungsi baru bernama **FileParser** menggunakan templat **pemicu HTTP**:

    ```powershell
    func new --template "HTTP trigger" --name "FileParser"
    ```

    > **Catatan**: Anda dapat meninjau dokumentasi untuk [create a new function][azure-functions-core-tools-new-function] menggunakan **Azure Functions Core Tools**.

1. Tutup aplikasi **Terminal Windows** yang sedang berjalan.

#### <a name="task-3-configure-and-read-an-application-setting"></a>Tugas 3: Konfigurasi dan baca pengaturan aplikasi

1. Pada layar **Mulai**, pilih petak peta **Visual Studio Code**.

1. Pada menu **File**, pilih **Buka Folder**.

1. Di jendela **File Explorer** yang terbuka, telusuri ke **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**, lalu pilih **Pilih Folder**.

1. Pada panel **Penjelajah** pada jendela **Visual Studio Code**, buka file **local.settings.json**.

1. Amati nilai objek **Nilai** saat ini:

    ```json
    "Values": {
        "AzureWebJobsStorage": "UseDevelopmentStorage=true",
        "FUNCTIONS_WORKER_RUNTIME": "dotnet"
    }
    ```

1. Perbarui nilai objek **Nilai** dengan menambahkan pengaturan baru bernama **StorageConnectionString**, lalu berikan nilai string **[TEST VALUE]** :

    ```json
    "Values": {
        "AzureWebJobsStorage": "UseDevelopmentStorage=true",
        "FUNCTIONS_WORKER_RUNTIME": "dotnet",
        "StorageConnectionString": "[TEST VALUE]"
    }
    ```

1. File **local.settings.json** sekarang harus menyertakan:

    ```json
    {
        "IsEncrypted": false,
        "Values": {
            "AzureWebJobsStorage": "UseDevelopmentStorage=true",
            "FUNCTIONS_WORKER_RUNTIME": "dotnet",
            "StorageConnectionString": "[TEST VALUE]"
        }
    }
    ```

1. Pilih **Simpan** untuk menyimpan perubahan Anda ke file **local.settings.json**.

1. Pada panel **Penjelajah** dari jendela **Visual Studio Code**, buka file **FileParser.cs**.

1. Di penyunting kode, amati contoh penerapan:

    ```csharp
    using System;
    using System.IO;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.Azure.WebJobs.Extensions.Http;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    using Newtonsoft.Json;
    namespace func
    {
        public static class FileParser
        {
            [FunctionName("FileParser")]
            public static async Task<IActionResult> Run(
                [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req,
                ILogger log)
            {
                log.LogInformation("C# HTTP trigger function processed a request.");
                string name = req.Query["name"];
                string requestBody = await new StreamReader(req.Body).ReadToEndAsync();
                dynamic data = JsonConvert.DeserializeObject(requestBody);
                name = name ?? data?.name;
                string responseMessage = string.IsNullOrEmpty(name)
                    ? "This HTTP triggered function executed successfully. Pass a name in the query string or in the request body for a personalized response."
                    : $"Hello, {name}. This HTTP triggered function executed successfully.";
                return new OkObjectResult(responseMessage);
            }
        }
    }
    ```

1. Hapus semua konten dalam file **FileParser.cs**.

1. Tambahkan baris kode berikut untuk menambahkan **using directives** untuk namespace **Microsoft.AspNetCore.Mvc**, **Microsoft.Azure.WebJobs**, **Microsoft.AspNetCore.Http**, **System**, dan **System.Threading.Tasks**:

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    ```

1. Buat kelas **public static** baru bernama **FileParser**:

    ```csharp
    public static class FileParser
    { }
    ```

1. Amati kembali file **FileParser.cs**, yang sekarang seharusnya menyertakan:

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    { }
    ```

1. Dalam kelas **FileParser**, tambahkan blok kode berikut untuk membuat metode **public static** *asynchronous* baru bernama **Run**. Metode ini mengembalikan variabel jenis **Task\<IActionResult\>** dan juga mengambil variabel jenis **HttpRequest** bernama *request*:

    ```csharp
    public static async Task<IActionResult> Run(
        HttpRequest request)
    { }
    ```

1. Tambahkan kode berikut untuk menambahkan atribut ke metode **Run** jenis **FunctionNameAttribute** yang parameter **name**-nya diatur ke nilai **FileParser** :

    ```csharp
    [FunctionName("FileParser")]
    public static async Task<IActionResult> Run(
        HttpRequest request)
    { }
    ```

1. Tambahkan kode berikut untuk menambahkan atribut ke parameter **request** jenis **HttpTriggerAttribute** yang memiliki kumpulan larik parameter **methods** yang diatur ke nilai tunggal **GET**:

    ```csharp
    [FunctionName("FileParser")]
    public static async Task<IActionResult> Run(
        [HttpTrigger("GET")] HttpRequest request)
    { }
    ```

1. Amati kembali file **FileParser.cs**, yang sekarang seharusnya menyertakan:

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    {
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
            [HttpTrigger("GET")] HttpRequest request)
        { }
    }
    ```

1. Pada metode **Run**, masukkan baris kode berikut untuk mengambil nilai pengaturan aplikasi **StorageConnectionString** menggunakan metode **Environment.GetEnvironmentVariable** dan untuk menyimpan hasilnya dalam variabel **string** bernama **connectionString**:

    ```csharp
    string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
    ```

1. Masukkan baris kode berikut untuk mengembalikan nilai variabel **connectionString** sebagai respons HTTP:

    ```csharp
    return new OkObjectResult(connectionString);
    ```

1. Amati kembali file **FileParser.cs**, yang sekarang seharusnya menyertakan:

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    {
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
            [HttpTrigger("GET")] HttpRequest request)
        {
            string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
            return new OkObjectResult(connectionString);
        }
    }
    ```

1. Pilih **Simpan** untuk menyimpan perubahan Anda ke file **FileParser.cs**.

#### <a name="task-4-validate-the-local-function"></a>Tugas 4: Memvalidasi fungsi lokal

1. Pada taskbar, pilih ikon **Terminal Windows**.

1. Jalankan perintah berikut untuk mengubah direktori saat ini ke direktori kosong **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Jalankan perintah berikut untuk menjalankan proyek aplikasi fungsi:

    ```powershell
    func start --build
    ```

    > **Catatan**: Anda dapat meninjau dokumentasi untuk [start the function app project locally][azure-functions-core-tools-start-function] menggunakan **Azure Functions Core Tools**.

1. Pada taskbar, pilih lagi ikon **Terminal Windows** untuk membuka instans baru aplikasi **Terminal Windows**. Jalankan perintah berikut untuk mengubah direktori saat ini ke direktori kosong **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```
    
1. Saat menerima perintah buka, jalankan perintah berikut untuk memulai alat **httprepl**, mengatur Pengidentifikasi Sumber Daya Seragam (URI) dasar ke ``http://localhost:7071``:

    ```powershell
    httprepl http://localhost:7071
    ```

    > **Catatan**: Pesan kesalahan ditampilkan oleh alat **httprepl**. Pesan ini terjadi karena alat sedang mencari file definisi Swagger yang akan digunakan untuk melintasi API. Karena proyek fungsi Anda tidak menghasilkan file definisi Swagger, Anda harus melintasi API secara manual.
1. Saat menerima perintah alat, jalankan perintah berikut untuk menelusuri ke direktori **api** relatif:

    ```powershell
    cd api
    ```

1. Jalankan perintah berikut untuk menelusuri ke direktori **fileparser** relatif:

    ```powershell
    cd fileparser
    ```

1. Jalankan perintah berikut untuk menjalankan perintah **get**:

    ```powershell
    get
    ```

1. Amati nilai **[TEST VALUE]** dari **StorageConnectionString** yang dikembalikan sebagai hasil dari permintaan HTTP:

    ```powershell
    HTTP/1.1 200 OK
    Content-Type: text/plain; charset=utf-8
    Date: Tue, 01 Sep 2020 23:35:39 GMT
    Server: Kestrel
    Transfer-Encoding: chunked
    [TEST VALUE]
    ```

1. Jalankan perintah berikut untuk keluar dari alat **httprepl**:

    ```powershell
    exit
    ```

1. Tutup semua instans aplikasi **Terminal Windows** yang saat ini sedang berjalan.

#### <a name="task-5-deploy-the-function-using-the-azure-functions-core-tools"></a>Tugas 5: Sebarkan fungsi menggunakan Azure Functions Core Tools

1. Pada taskbar, pilih ikon **Terminal Windows**.

1. Jalankan perintah berikut untuk mengubah direktori saat ini ke direktori kosong **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Jalankan perintah berikut untuk masuk ke Antarmuka Baris Perintah Azure (CLI):

    ```powershell
    az login
    ```

1. Di jendela browser **Microsoft Edge**, masukkan alamat email dan sandi untuk akun Microsoft Anda, lalu pilih **Masuk**.

1. Kembali ke jendela **Terminal Windows** yang saat ini terbuka. Tunggu hingga proses masuk selesai.

1. Jalankan perintah berikut untuk menerbitkan proyek aplikasi fungsi:

    ```powershell
    func azure functionapp publish <function-app-name>
    ```

    > **Catatan**: Sebagai contoh, jika **Nama Aplikasi Fungsi** Anda adalah **securefuncstudent**, perintah Anda adalah ``func azure functionapp publish securefuncstudent``. Anda dapat meninjau dokumentasi untuk [publish the local function app project][azure-functions-core-tools-publish-azure] menggunakan **Azure Functions Core Tools**.

1. Tunggu hingga penyebaran selesai sebelum Anda melanjutkan dengan lab.

1. Tutup aplikasi **Terminal Windows** yang sedang berjalan.

#### <a name="task-6-test-the-key-vault-derived-application-setting"></a>Tugas 6: Uji pengaturan aplikasi yang diturunkan dari Brankas Kunci

1. Pada taskbar, pilih ikon **Microsoft Edge**, lalu pilih tab yang berisi portal Azure (<https://portal.azure.com>).

1. Di panel navigasi portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih aplikasi fungsi **securefunc[yourname]** .

1. Pada panel **Aplikasi Fungsi**, pilih opsi **Functions** di bagian **Functions**.

1. Pada panel **Functions**, pilih fungsi **FileParser** yang ada.

1. Pada panel **Functions**, pilih opsi **Kode + Uji** di bagian **Pengembang**.

1. Di editor fungsi, pilih **Uji/Jalankan**.

1. Pada kotak dialog pop-up yang ditampilkan, dalam daftar **Metode HTTP**, pilih **GET**.

1. Pilih **Jalankan** untuk menguji fungsi.

1. Perhatikan hasil uji coba. Hasilnya harus berupa string koneksi Azure Storage Anda.

#### <a name="review"></a>Tinjau

Dalam latihan ini, Anda telah menggunakan identitas layanan untuk membaca nilai rahasia yang disimpan di Brankas Kunci dan mengembalikan nilai tersebut sebagai hasil dari aplikasi fungsi.

### <a name="exercise-4-access-azure-blob-storage-data"></a>Latihan 4: Mengakses data Penyimpanan Azure Blob

#### <a name="task-1-upload-a-sample-storage-blob"></a>Tugas 1: Mengunggah blob penyimpanan sampel

1. Di panel navigasi portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih akun penyimpanan **securestor** _[yourname]_ .

1. Pada panel **Akun penyimpanan**, pilih tautan **Kontainer** di bagian **Penyimpanan data**.

1. Di bagian **Kontainer**, pilih **+ Kontainer**.

1. Di jendela pop-up **Kontainer baru**, lakukan tindakan berikut, lalu pilih **Buat**:

    | Pengaturan | Tindakan |
    | --- | --- |
    | Kotak teks **Nama** | Masukkan **drop** |
    | Daftar drop-down **Tingkat akses publik** | Pilih **Blob (akses baca anonim hanya untuk blob)** . |

1. Kembali ke bagian **Kontainer**, lalu pilih penampung **drop** yang baru dibuat.

1. Pada panel **Kontainer**, pilih **Unggah**.

1. Di jendela **Unggah blob**, lakukan tindakan berikut, lalu pilih **Unggah**:

    | Pengaturan | Tindakan |
    | --- | --- |
    | Bagian **File** | Pilih ikon **Folder**. |
    | Jendela **File Explorer** | Jelajahi ke file **Allfiles (F):\\Allfiles\\Labs\\07\\Starter**, select the **records.json**, lalu pilih **Buka**. |
    | Kotak centang **Timpa jika file sudah ada** | Pastikan kotak centang ini dipilih. |

    > **Catatan**: Tunggu hingga blob diunggah sebelum Anda melanjutkan dengan lab ini.

1. Kembali ke panel **Kontainer**, lalu pilih blob **records.json** dalam daftar blob.

1. Pada bilah **Blob**, temukan metadata blob, lalu salin URL untuk blob tersebut.

1. Pada taskbar, aktifkan menu pintasan untuk ikon **Microsoft Edge**, lalu pilih **Jendela baru**.

1. Di jendela browser baru, lihat URL yang Anda salin untuk blob.

1. Konten JavaScript Object Notation (JSON) dari blob sekarang harus ditampilkan. Tutup jendela browser dengan konten JSON.

1. Kembali ke jendela browser dengan portal Azure, lalu tutup bilah **Blob**.

1. Kembali ke panel **Kontainer**, lalu pilih **Ubah tingkat akses**.

1. Di jendela pop-up **Ubah tingkat akses**, lakukan tindakan berikut:

    1. Dalam daftar drop-down **Tingkat akses publik**, pilih **Pribadi (tanpa akses anonim)** .

    1. Pilih **OK**.

1. Pada taskbar, aktifkan menu pintasan untuk ikon **Microsoft Edge**, lalu pilih **Jendela baru**.

1. Di jendela browser baru, lihat URL yang Anda salin untuk blob.

1. Pesan kesalahan yang menunjukkan bahwa sumber daya yang tidak ditemukan sekarang akan ditampilkan.

    > **Catatan**: Jika pesan kesalahan tidak muncul, browser Anda mungkin telah menyimpan file dalam cache. Pilih Ctrl+F5 untuk menyegarkan halaman hingga pesan kesalahan ditampilkan.

#### <a name="task-2-pull-and-configure-the-azure-sdk-for-net"></a>Tugas 2: Pull dan konfigurasikan Azure SDK untuk .NET

1. Pada taskbar, pilih ikon **Terminal Windows**.

1. Jalankan perintah berikut untuk mengubah direktori saat ini ke direktori kosong **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Jalankan perintah berikut untuk menambahkan versi **12.6.0** paket **Azure.Storage.Blobs** dari NuGet:

    ```powershell
    dotnet add package Azure.Storage.Blobs --version 12.6.0
    ```

    > **Catatan**: Paket NuGet [Azure.Storage.Blobs](https://www.nuget.org/packages/Azure.Storage.Blobs/12.6.0) merujuk pada subset Azure SDK untuk .NET yang diperlukan untuk menulis kode untuk Azure Blob Storage.

1. Tutup aplikasi **Terminal Windows** yang sedang berjalan.

1. Pada layar **Mulai**, pilih petak peta **Visual Studio Code**.

1. Pada menu **File**, pilih **Buka Folder**.

1. Di jendela **File Explorer** yang terbuka, telusuri ke **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**, lalu pilih **Pilih Folder**.

1. Pada panel **Penjelajah** dari jendela **Visual Studio Code**, buka file **FileParser.cs**.

1. Tambahkan **using directive** untuk ruang nama **Azure.Storage.Blobs**:

    ```csharp
    using Azure.Storage.Blobs;
    ```

1. Amati file **FileParser.cs**, yang sekarang seharusnya menyertakan:

    ```csharp
    using Azure.Storage.Blobs;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    {
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
            [HttpTrigger("GET")] HttpRequest request)
        {
            string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
            return new OkObjectResult(connectionString);
        }
    }
    ```

#### <a name="task-3-write-azure-blob-storage-code-using-the-azure-sdk-for-net"></a>Tugas 3: Tulis kode Azure Blob Storage menggunakan Azure SDK untuk .NET

1. Dalam metode **Run** dari kelas **FileParser**, hapus baris kode berikut:

    ```csharp
    return new OkObjectResult(connectionString);
    ```

1. Masih dalam metode **Run**, tambahkan blok kode berikut untuk membuat instans baru kelas **BlobClient** dengan meneruskan variabel *connectionString* Anda, nilai string ``"drop"``, dan nilai string ``"records.json"`` ke konstruktor:

    ```csharp
    BlobClient blob = new BlobClient(connectionString, "drop", "records.json");
    ```

1. Masih dalam metode **Run**, tambahkan blok kode berikut untuk menggunakan metode **BlobClient.DownloadAsync** untuk mengunduh konten blob yang direferensikan secara asinkron, lalu menyimpan hasilnya dalam variabel bernama *response*:

    ```csharp
    var response = await blob.DownloadAsync();
    ```

1. Masih dalam metode **Run**, tambahkan blok kode berikut untuk mengembalikan nilai berbagai konten yang disimpan dalam variabel *konten* menggunakan konstruktor kelas **FileStreamResult**:

    ```csharp
    return new FileStreamResult(response?.Value?.Content, response?.Value?.ContentType);
    ```

1. Amati kembali file **FileParser.cs**, yang sekarang seharusnya menyertakan:

    ```csharp
    using Azure.Storage.Blobs;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    public static class FileParser
    {
        [FunctionName("FileParser")]
        public static async Task<IActionResult> Run(
            [HttpTrigger("GET")] HttpRequest request)
        {
            string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
            BlobClient blob = new BlobClient(connectionString, "drop", "records.json");
            var response = await blob.DownloadAsync();
            return new FileStreamResult(response?.Value?.Content, response?.Value?.ContentType);
        }
    }
    ```

1. Pilih **Simpan** untuk menyimpan perubahan Anda ke file **FileParser.cs**.

#### <a name="task-4-deploy-and-validate-the-azure-functions-app"></a>Tugas 4: Menyebarkan dan memvalidasi aplikasi Azure Functions

1. Pada taskbar, pilih ikon **Terminal Windows**.

1. Jalankan perintah berikut untuk mengubah direktori saat ini ke direktori kosong **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

    ```powershell
    cd F:\Allfiles\Labs\07\Starter\func
    ```

1. Jalankan perintah berikut untuk masuk ke Azure CLI:

    ```powershell
    az login
    ```
1. Di jendela browser **Microsoft Edge**, masukkan alamat email dan sandi untuk akun Microsoft Anda, lalu pilih **Masuk**.

1. Kembali ke jendela **Terminal Windows** yang saat ini terbuka. Tunggu hingga proses masuk selesai.

1. Jalankan perintah berikut untuk memublikasikan proyek aplikasi fungsi lagi:

    ```powershell
    func azure functionapp publish <function-app-name>
    ```

    > **Catatan**: Sebagai contoh, jika **Nama Aplikasi Fungsi** Anda adalah **securefuncstudent**, perintah Anda adalah ``func azure functionapp publish securefuncstudent``. Anda dapat meninjau dokumentasi untuk [publish the local function app project][azure-functions-core-tools-publish-azure] menggunakan **Azure Functions Core Tools**.

1. Tunggu hingga penyebaran selesai sebelum Anda melanjutkan dengan lab.

1. Tutup aplikasi **Terminal Windows** yang sedang berjalan.

1. Pada taskbar, pilih ikon **Microsoft Edge**, lalu referensikan ke portal Microsoft Azure (<https://portal.azure.com>).

1. Di panel navigasi portal Microsoft Azure, pilih tautan **Grup sumber daya**.

1. Pada panel **Grup sumber daya**, pilih grup sumber daya **ConfidentialStack**.

1. Pada panel **ConfidentialStack**, pilih aplikasi fungsi **securefunc[yourname]** .

1. Pada panel **Layanan Aplikasi**, pilih opsi **Functions** di bagian **Functions**.

1. Pada panel **Functions**, pilih fungsi **FileParser** yang ada.

1. Pada panel **Functions**, pilih opsi **Kode + Uji** di bagian **Pengembang**.

1. Di editor fungsi, pilih **Uji/Jalankan**.

1. Pada kotak dialog pop-up yang ditampilkan, dalam daftar **Metode HTTP**, pilih **GET**.

1. Pilih **Jalankan** untuk menguji fungsi.

1. Perhatikan hasil uji coba. Outputnya akan berisi konten dari blob **$/drop/records.json** yang disimpan di akun Azure Storage Anda.

#### <a name="review"></a>Tinjau

Dalam latihan ini, Anda menggunakan kode C\# untuk mengakses akun penyimpanan, lalu mengunduh konten blob.

### <a name="exercise-5-clean-up-your-subscription"></a>Latihan 5: Membersihkan langganan Anda

#### <a name="task-1-open-azure-cloud-shell"></a>Tugas 1: Membuka Azure Cloud Shell

1. Di portal Microsoft Azure, pilih ikon **Cloud Shell** ![ikon Cloud Shell](./media/az204_lab_CloudShell.png) untuk membuka sesi Bash baru. Jika sesi Cloud Shell default ke PowerShell, pilih **PowerShell**, dan di menu drop-down, pilih **Bash**.

    > **Catatan**: Jika ini pertama kalinya Anda memulai **Cloud Shell**, saat diminta untuk memilih **Bash** atau **PowerShell**, pilih **PowerShell**. Saat Anda melihat pesan **Anda tidak memiliki penyimpanan yang terpasang**, pilih langganan yang Anda gunakan di lab ini, lalu pilih **Buat penyimpanan**.

#### <a name="task-2-delete-a-resource-group"></a>Tugas 2: Menghapus grup sumber daya

1. Pada panel **Cloud Shell**, jalankan perintah berikut untuk menghapus grup sumber daya **ConfidentialStack**:

    ```bash
    az group delete --name ConfidentialStack --no-wait --yes
    ```

     > **Catatan**: Perintah berjalan secara asinkron (seperti yang ditentukan oleh parameter *--no-wait*), jadi sementara Anda dapat menjalankan perintah Azure CLI lain segera setelahnya dalam sesi Bash yang sama, perlu waktu beberapa menit sebelum kelompok sumber daya benar-benar dihapus.

1. Tutup panel **Cloud Shell** di portal.

#### <a name="task-3-close-the-active-application"></a>Tugas 3: Menutup aplikasi yang aktif

- Tutup aplikasi Microsoft Edge yang sedang berjalan.

#### <a name="review"></a>Tinjau

Dalam latihan ini, Anda membersihkan langganan Anda dengan menghapus grup sumber daya yang digunakan di lab ini.
